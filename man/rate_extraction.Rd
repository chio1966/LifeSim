% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/rate-extraction.R
\name{rate_extraction}
\alias{rate_extraction}
\title{Extract Life Table Rates and Time Intervals}
\usage{
rate_extraction(df, ratetable, mapping, start, end, rate_scale, time_scale)
}
\arguments{
\item{df}{A \code{data.frame} containing individual-level data. Must include columns for age, sex, etc., as described in \code{mapping}.}

\item{ratetable}{A multi-dimensional life table object, such as those from \code{survival::survexp.us}.}

\item{mapping}{A named character vector mapping column names in \code{df} to dimension names in \code{ratetable}. The first two elements must be the names corresponding to age and year.
E.g., \code{c("age" = "age", "year" = "year", "sex" = "sex", "ethnicity" = "race")}.}

\item{start}{A string giving the column name in \code{df} for diagnosis or start date.}

\item{end}{A string giving the column name in \code{df} for end of follow-up.}

\item{rate_scale}{A numeric multiplier to rescale extracted rates this will depends on the ratetable.}

\item{time_scale}{A numeric multiplier to rescale time units the default time is given in days, adjust accordingly.}
}
\value{
A list with two elements:
\describe{
\item{times}{A list of numeric vectors giving time intervals per individual in days}
\item{rates}{A list of numeric vectors giving hazard rates per interval per individual.}
}
}
\description{
Given a data frame of individuals with diagnosis dates, demographic covariates, and a life table,
this function computes a list of time intervals and corresponding hazard rates for each individual.
Useful for modeling survival using population-level expected mortality.
}
\examples{
library(lubridate)
library(dplyr)
library(survival)

# Simulate test data
set.seed(123)
n <- 200

# Random diagnosis dates between 1970 and 1972
start_date <- as.Date("1970-01-01") + runif(n, 0, as.numeric(as.Date("1972-12-31") - as.Date("1970-01-01")))

# Random end dates between 1985 and 1986
end_date <- as.Date("1985-01-01") + runif(n, 0, as.numeric(as.Date("1986-12-31") - as.Date("1985-01-01")))

# Ages at diagnosis between 40 and 70
age <- runif(n, 40, 70)

# Sex and ethnicity as factors
sex <- sample(c("male", "female"), n, replace = TRUE)
ethnicity <- sample(c("white", "black"), n, replace = TRUE)

# Assemble data frame
test_df <- data.frame(
  start_date = start_date,
  end_date = end_date,
  age = age,
  sex = sex,
  ethnicity = ethnicity
)

# Define mapping to ratetable dimensions
mapping <- c("age" = "age", "year" = "year", "sex" = "sex", "ethnicity" = "race")

# Use the population rate table from the 'survival' package
ratetable <- survival::survexp.usr

# Run the extraction
result <- rate_extraction(
  df = test_df,
  ratetable = ratetable,
  mapping = mapping,
  start = "start_date",
  end = "end_date",
  rate_scale = 365.25,      # Convert yearly rates to daily
  time_scale = 1 / 365.25   # Convert days to years
)

# Inspect structure
str(result)


}
